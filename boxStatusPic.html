<!doctype html> 
<html>
    <head>
        <meta charset="utf8" />
        <title>Box Connection Status</title>
        <script src="/jquery-1.11.3.min.js"></script>
        <script src="/socket.io-1.3.5.js"></script>
        <script>
            var socket = io();
            var tatalData;
            var mapDoc;

            var totalE = 0,    totalG = 0,    totalA = 0,    totalTC = 0;
            var goodE = 0,     goodG = 0,     goodA = 0,     goodTC = 0;
            var notGoodE = 0, notGoodG = 0, notGoodA = 0, notGoodTC = 0;
            var rateE = 0,     rateG = 0,     rateA = 0,     rateTC = 0;

            var totalMachine = 0, totalRed = 0, totalGray = 0;

            socket.on('PING', function(msg) {
              console.log('get PING!');
              // 0. reset num
              totalE = 0;    totalG = 0;    totalA = 0;    totalTC = 0;
              goodE = 0;     goodG = 0;     goodA = 0;     goodTC = 0;
              notGoodE = 0; notGoodG = 0; notGoodA = 0; notGoodTC = 0;
              // 0. parse income data into totalData
              totalData = jQuery.parseJSON(msg);

              // 1. get .SVG file content
              if (mapDoc == null) { 
                var factoryMap = document.getElementById("factory_map");
                mapDoc = factoryMap.contentDocument;
              }

              // 2. get all elements with param, class='machine'
              var allMachine = mapDoc.getElementsByClassName("machine");
              console.log('total count: '+ allMachine.length);

              // 3. setup color
              for (var idx = 0; idx < allMachine.length; idx++) {
                // special for G111_2, G111_3
                if (allMachine[idx].id === 'G111_2' || allMachine[idx].id === 'G111_3') {
                  allMachine[idx].style.fill = '#cccccc';
                }
                var data = totalData.filter(function(obj) {
                  return obj.ID === allMachine[idx].id;
                });
                if (data.length > 0) {
/*
                  console.log(data[0].ID + 
                    ', IP: '     + data[0].IP +
                    ', NOTE: '   + data[0].NOTE +
                    ', STATUS: ' + data[0].STATUS + 
                    ', ALIVE: '  + data[0].ALIVE +
                    ', QTY: '    + data[0].QTY);
*/
                  if (data[0].ALIVE == 1) { // Pi is alive!
                    if (data[0].STATUS === '01') {
                      if (data[0].QTY == 0) { // working, but qty = 0
                        allMachine[idx].style.fill = '#006600';
                        //console.log(data[0].ID);
                        count(data[0].ID, 0);
                      } else {                // working with good qty!
                        allMachine[idx].style.fill = '#00ff00';
                        count(data[0].ID, 1);
                      }
                    } else 
                    if (data[0].STATUS === '05') { // idle
                      allMachine[idx].style.fill = '#ffff00';
                      count(data[0].ID, 1);
                    } else 
                    if (data[0].STATUS === '10' || data[0].STATUS === '') { // standby
                      allMachine[idx].style.fill = '#ff0000';
                      count(data[0].ID, 0);
                    } else {
                      allMachine[idx].style.fill = '#00ff00';
                      count(data[0].ID, 1);
                    }
                  } else
                  if(data[0].ALIVE == 0 && data[0].NOTE === '') { // fucking dead Pi
                    allMachine[idx].style.fill = '#0000ff';
                    count(data[0].ID, 0);
                  }

                  if (data[0].NOTE !== '') { // not install Pi
                    allMachine[idx].style.fill = '#cccccc';
                  }
                }
              }

              $('#data table').empty();
              $('#data table').append('<tr>' +
                                        '<th>ID</th>' + 
                                        '<th>類型</th>' + 
                                        '<th>IP地址</th>'+ 
                                        '<th>備註</th>' + 
                                        '<th>機器狀態</th>' + 
                                        '<th>監控上線狀態(1:線上)</th>' + 
                                        '<th>今日良品數</th></tr>');
              for (var idx = 0; idx < totalData.length; idx++) {
                $('#data table').append('<tr><td width="10%">' + totalData[idx].ID   + '</td>' +
                                            '<td width="10%">' + totalData[idx].TYPE + '</td>' +
                                            '<td width="10%">' + totalData[idx].IP   + '</td>' +
                                            '<td width="10%">' + totalData[idx].NOTE + '</td>' +
                                            '<td width="10%">' + totalData[idx].STATUS + '</td>' +
                                            '<td width="10%">' + totalData[idx].ALIVE + '</td>' +
                                            '<td width="10%">' + totalData[idx].QTY + '</td></tr>');
              }
            });

            function count(ID, isGood) {
              if (ID.indexOf('E') > -1) {                         // 加締
                totalE++;
                if (Boolean(isGood)) { goodE++; } else { notGoodE++; }
                rateE = new Number(goodE / totalE * 100);
              } else
              if (ID.indexOf('G') > -1) {                         // 組立
                totalG++;
                if (Boolean(isGood)) { goodG++; } else { notGoodG++; }
                rateG = new Number(goodG / totalG * 100);
              } else
              if (ID.indexOf('A') > -1) {                         // 老化
                totalA++;
                if (Boolean(isGood)) { goodA++; } else { notGoodA++; }
                rateA = new Number(goodA / totalA * 100);
              } else
              if (ID.indexOf('T') > -1 || ID.indexOf('C') > -1) { // 其他
                totalTC++;
                if (Boolean(isGood)) { goodTC++; } else { notGoodTC++; }
                rateTC = new Number(goodTC / totalTC * 100);
              }
              $('#E_TOTAL').html(totalE);
              $('#E_GOOD').html(goodE);
              $('#E_NOTGOOD').html(notGoodE);
              $('#E_RATE').html(rateE.toFixed(2) + '%');
              $('#G_TOTAL').html(totalG);
              $('#G_GOOD').html(goodG);
              $('#G_NOTGOOD').html(notGoodG);
              $('#G_RATE').html(rateG.toFixed(2) + '%');
              $('#A_TOTAL').html(totalA);
              $('#A_GOOD').html(goodA);
              $('#A_NOTGOOD').html(notGoodA);
              $('#A_RATE').html(rateA.toFixed(2) + '%');
              $('#TC_TOTAL').html(totalTC);
              $('#TC_GOOD').html(goodTC);
              $('#TC_NOTGOOD').html(notGoodTC);
              $('#TC_RATE').html(rateTC.toFixed(2) + '%');
            }

            socket.on('SUM', function(msg) {
              var data = jQuery.parseJSON(msg);
              var data = jQuery.parseJSON(msg);
              $('#BIG_E').html(data.BIG_E);
              $('#BIG_G').html(data.BIG_G);
              $('#BIG_A').html(data.BIG_A);
              $('#BIG_A4').html(data.BIG_A4);
              $('#BIG_TC').html(data.BIG_TC);

              $('#MEDIUM_E').html(data.MEDIUM_E);
              $('#MEDIUM_G').html(data.MEDIUM_G)
              $('#MEDIUM_A').html(data.MEDIUM_A);
              $('#MEDIUM_A4').html(data.MEDIUM_A4);
              $('#MEDIUM_TC').html(data.MEDIUM_TC);

              $('#SMALL_E').html(data.SMALL_E);
              $('#SMALL_G').html(data.SMALL_G);
              $('#SMALL_A').html(data.SMALL_A);
              $('#SMALL_A4').html(data.SMALL_A4);
              $('#SMALL_TC').html(data.SMALL_TC);

              updateDate();
            });

            function getCSVfile() {
                var fileName = "report";
                
                //var array  = typeof tatalData != 'object' ? JSON.parse(tatalData) : tatalData;
                //var array  = tatalData;
                var str = 'ID,TYPE,IP,NOTE,STATUS,ALIVE,QTY\r\n';
                
                for(var x = 0; x < totalData.length; x++) {
                    var line = '';
                    for(var index in totalData[x]) {
                        if(line != '') line += ',';
                        line += totalData[x][index];
                    }
                    str += line + '\r\n';
                }
                
                var uri = 'data:text/csv;charset=utf-8,' + escape(str);
                
                var link = document.createElement("a");    
                link.href = uri;
                link.style = "visibility:hidden";
                link.download = fileName + ".csv";
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                //if (navigator.appName != 'Microsoft Internet Explorer') {
                //    window.open('data:text/csv;charset=utf-8,' + escape(str));
                //} else {
                //    var popup = window.open('','csv','');
                //    popup.document.body.innerHTML = '<pre>' + str + '</pre>';
                //}    
            }

            Number.prototype.padLeft = function(base,chr){
                var  len = (String(base || 10).length - String(this).length)+1;
                return len > 0? new Array(len).join(chr || '0')+this : this;
            }

            function updateDate() {
                var d = new Date,
                    dformat = [ d.getFullYear(),
                               (d.getMonth()+1).padLeft(),
                                d.getDate().padLeft()].join('/')+
                                ' ' +
                              [ d.getHours().padLeft(),
                                d.getMinutes().padLeft(),
                                d.getSeconds().padLeft()].join(':');
                $('#nowTime').html(dformat);
                $('#nowTime_2').html(dformat);
            }

            function loadMapOK() {
                var factoryMap = document.getElementById("factory_map");
                mapDoc = factoryMap.contentDocument;
                socket.emit('boxStatusPic','loadFinish');
            }
        </script>
    </head>
    <body>    
        <div><input type="button" value="CSV Report" onclick="getCSVfile()" /></div><br />
        <!-- 分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線 -->
        <div id="dailySum">
            <table border="1" width="80%">
                <caption>今日良品數統計，<br />統計時間:<b id="nowTime"></b></caption>
                <thead>
                    <tr>
                        <th />
                        <th>加締卷取</th>
                        <th>組立</th>
                        <th>老化</th>
                        <th>選別</th>
                        <th>加工切角</th>
                    </tr>
                </thead>
                <tbody align="center">
                    <tr>
                        <td>&#934; 16 - 18</td>
                        <td id="BIG_E"/>
                        <td id="BIG_G"/>
                        <td id="BIG_A"/>
                        <td id="BIG_A4"/>
                        <td id="BIG_TC"/>
                    </tr>
                    <tr>
                        <td>&#934; 10 - 12.5</td>
                        <td id="MEDIUM_E"/>
                        <td id="MEDIUM_G"/>
                        <td id="MEDIUM_A"/>
                        <td id="MEDIUM_A4"/>
                        <td id="MEDIUM_TC"/>
                    </tr>
                    <tr>
                        <td>&#934; 5 - 8</td>
                        <td id="SMALL_E"/>
                        <td id="SMALL_G"/>
                        <td id="SMALL_A"/>
                        <td id="SMALL_A4"/>
                        <td id="SMALL_TC"/>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- 分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線 -->
        <br />
        <div id="Availability">
            <table border="1" width="80%">
                <caption>目前稼動率，<br />統計時間:<b id="nowTime_2"></b></caption>
                <thead>
                    <tr>
                        <th>類型</th>
                        <th>圖例</th>
                        <th>總裝機數</th>
                        <th bgcolor="#00ff00">正常</th><th bgcolor="#ffff00">閒置</th>
                        <th bgcolor="#006600">無良品數</th><th bgcolor="#ff0000">待機</th><th bgcolor="#0000ff">未上線</th>
                        <th>稼動率</th>
                    </tr>
                </thead>
                <tbody align="center">
                    <tr>
                        <td>加締</td>
                        <td><object data="/square.svg" type="image/svg+xml" width="30%" height="30%"></object></td>
                        <td id="E_TOTAL"></td>
                        <td id="E_GOOD" colspan="2"></td>
                        <td id="E_NOTGOOD" colspan="3"></td>
                        <td id="E_RATE"></td>
                    </tr>
                    <tr>
                        <td>組立</td>
                        <td><object data="/triangle.svg" type="image/svg+xml" width="30%" height="30%"></object></td>
                        <td id="G_TOTAL"></td>
                        <td id="G_GOOD" colspan="2"></td>
                        <td id="G_NOTGOOD" colspan="3"></td>
                        <td id="G_RATE"></td>
                    </tr>
                    <tr>
                        <td>老化</td>
                        <td><object data="/circle.svg" type="image/svg+xml" width="30%" height="30%"></object></td>
                        <td id="A_TOTAL"></td>
                        <td id="A_GOOD" colspan="2"></td>
                        <td id="A_NOTGOOD" colspan="3"></td>
                        <td id="A_RATE"></td>
                    </tr>
                    <tr>
                        <td>其他(選別，加工，切角)</td>
                        <td><object data="/pentagon.svg" type="image/svg+xml" width="30%" height="30%"></object></td>
                        <td id="TC_TOTAL"></td>
                        <td id="TC_GOOD" colspan="2"></td>
                        <td id="TC_NOTGOOD" colspan="3"></td>
                        <td id="TC_RATE"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- 分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線 -->
        <br /><br /><br />
        <div id="Sample">
            <table border="0" width="50%">
                <caption><b>顏色代表狀態</b></caption>
                <thead>
                    <tr>
                        <th>顏色</th><th>代表狀態</th>
                    </tr>
                </thead>
                <tbody align="center">
                    <tr>
                      <td width="20%" bgcolor="#00ff00"/>
                      <td width="20%" align="left">機器正常運作</td>
                    </tr>
                    <tr>
                      <td width="20%" bgcolor="#006600"/>
                      <td width="20%" align="left">機器正常，但沒有良品數</td>
                    </tr>
                    <tr>
                      <td width="20%" bgcolor="#ffff00"/>
                      <td width="20%" align="left">閒置(05:idle)</td>
                    </tr>
                    <tr>
                      <td width="20%" bgcolor="#ff0000"/>
                      <td width="20%" align="left">待機(10:standby)</td>
                    </tr>
                    <tr>
                      <td width="20%" bgcolor="#0000ff"/>
                      <td width="20%" align="left">機器未上線</td>
                    </tr>
                    <tr>
                      <td width="20%" bgcolor="#cccccc"/>
                      <td width="20%" align="left">未安裝監控</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- 分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線 -->
        <br />
        <object onload="loadMapOK();" data="/optimized_2.svg" type="image/svg+xml" id="factory_map" width="100%" height="100%"></object>
        <!-- 分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線分隔線 -->
        <div id="data">
            <table border="1" width="80%">
                <tbody>
                </tbody>
            </table>
        </div>

        
    </body>
</html>
